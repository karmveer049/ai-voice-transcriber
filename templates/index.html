<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device_width, initial-scale=1.0">
    <title>AI Voice Note Taker (MCA Project)</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6; background-color: #f4f4f9; }
        h1 { color: #333; text-align: center; }
        .container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        #recordBtn { background-color: #e74c3c; color: white; }
        #stopBtn { background-color: #333; color: white; }
        #submitBtn { background-color: #2ecc71; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { text-align: center; margin: 10px 0; font-style: italic; color: #666; }
       .result-box { 
    margin-top: 20px; 
    padding: 15px; 
    background: #f8f9fa; 
    border-left: 5px solid #2ecc71; 
   }
        .summary-box { border-left-color: #3498db; }
        textarea { width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üéôÔ∏è Multilingual AI Transcriber</h1>
        <p style="text-align: center;">Supports Hindi, English & Hinglish</p>

        <div class="controls">
            <button id="recordBtn">Start Recording</button>
            <button id="stopBtn" disabled>Stop</button>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <span>OR Upload Audio: </span>
            <input type="file" id="audioFile" accept="audio/*">
            <button id="submitBtn">Process Audio</button>
        </div>

        <div id="status" class="status">Ready</div>

        <div id="results" style="display:none;">
            <div class="result-box">
                <h3>üìú Original Transcript</h3>
                <p id="transcriptText"></p>
            </div>
            
            <div class="result-box summary-box">
                <h3>üß† AI Summary & Context</h3>
                <div id="summaryText"></div>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const submitBtn = document.getElementById('submitBtn');
        const status = document.getElementById('status');

        // --- Recording Logic ---
        recordBtn.addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                handleUpload(audioBlob, "recording.wav");
            };

            mediaRecorder.start();
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            status.textContent = "Recording... Speak in Hindi, English or Hinglish";
        });

        stopBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = "Processing recording...";
        });

        // --- File Upload Logic ---
        submitBtn.addEventListener('click', () => {
            const fileInput = document.getElementById('audioFile');
            if (fileInput.files.length === 0) {
                alert("Please select a file first");
                return;
            }
            handleUpload(fileInput.files[0], fileInput.files[0].name);
        });

        // --- Core Upload Function ---
        async function handleUpload(audioData, filename) {
            status.textContent = "Sending to AI Engine (Whisper + Gemini)...";
            document.getElementById('results').style.display = 'none';
            
            const formData = new FormData();
            formData.append("file", audioData, filename);

            try {
                const response = await fetch('/process-audio/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.error) {
                    status.textContent = "Error: " + data.error;
                } else {
                    status.textContent = "Done!";
                    document.getElementById('results').style.display = 'block';
                    document.getElementById('transcriptText').textContent = data.original_text;
                    
                    // Format summary (convert newlines to <br>)
                    let formattedSummary = data.summary.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                    document.getElementById('summaryText').innerHTML = formattedSummary;
                }
            } catch (error) {
                console.error(error);
                status.textContent = "An error occurred during upload.";
            }
        }
    </script>
</body>
</html>